# Godot UI Theming System - Critical Amendments

## Context
This document clarifies implementation details in response to Momus review. Read this BEFORE `.sisyphus/plans/godot-ui-theming-system.md`.

---

## Amendment 1: State Type System Expansion

### Current Type Constraint (in repo)
```typescript
// api/src/ai/pipeline/types.ts
states: Array<'normal' | 'hover' | 'pressed' | 'disabled' | 'focus'>;
```

### MUST CHANGE TO
```typescript
states: Array<'normal' | 'hover' | 'pressed' | 'disabled' | 'focus' | 'selected' | 'unselected'>;
```

### Rationale
TabBar requires `selected` and `unselected` states. Without this type expansion, Task 1 will fail TypeScript compilation.

### Implementation Note
Task 1 MUST include this type union expansion as first step.

---

## Amendment 2: Non-Square Control Dimensions

### Problem
- ProgressBar: 256×64 (not square)
- ScrollBar H: 256×32 (not square)
- ScrollBar V: 32×256 (not square)
- TabBar: 128×48 (not square)

Current pipeline assumes square `canvasSize`.

### Solution
Use existing `SheetSpecBase.width` and `height` fields:

```typescript
// api/src/ai/pipeline/types.ts - ALREADY EXISTS
export interface SheetSpecBase {
  type: 'sheet';
  id: string;
  kind: SheetKind;
  layout: SheetLayout;
  width?: number;    // ← USE THIS
  height?: number;   // ← USE THIS
  // ...
}
```

### Implementation Changes

**Task 3-6 (Silhouette Generators)**:
- Accept `{ width, height }` parameters (not just `canvasSize`)
- Return appropriately sized PNG buffers

**Task 8 (Pipeline Stages)**:
- Pass `spec.width` and `spec.height` to silhouette generators
- Store actual dimensions in metadata (not assumed square)

**Metadata Format**:
```json
{
  "componentType": "progress_bar",
  "width": 256,
  "height": 64,
  "states": {
    "normal": { "region": { "x": 0, "y": 0, "width": 256, "height": 64 }, "r2Key": "..." }
  },
  "ninePatchMargins": { "left": 8, "right": 8, "top": 8, "bottom": 8 }
}
```

---

## Amendment 3: Batch API Execution Model

### Current POC Pattern
```typescript
// api/src/trpc/routes/ui-components.ts (POC)
generateUIComponent: async ({ input }) => {
  // Creates pack in DB
  // Returns job ID
  // User calls processUIComponentJob separately (async)
}
```

### This Plan Uses: SYNCHRONOUS Generation

**Rationale**: <5 minute total generation time is acceptable for synchronous HTTP response.

```typescript
generateUITheme: async ({ input }) => {
  const results = [];
  
  // Sequential, synchronous generation
  for (const controlType of input.controls) {
    const result = await executeGameAssets(/*...*/);  // BLOCKING
    results.push(result);
  }
  
  return { results };  // All done, return immediately
}
```

**Trade-offs**:
- ✅ Simpler (no job polling)
- ✅ Immediate results
- ❌ HTTP timeout risk if >5 minutes (acceptable given 6 controls × ~30-40s each = ~4 minutes max)

**If timeout becomes issue**: Switch to job-based model later (out of scope for this plan).

---

## Amendment 4: Multi-Part Control Asset Strategy

### Clarification: What Gets Generated

| Control | Generated by Plan | Not Generated (Use Godot Defaults) |
|---------|-------------------|-----------------------------------|
| **Panel** | Frame background (hollow) | N/A |
| **ProgressBar** | Track background | Fill bar (runtime color) |
| **ScrollBar** | Track background | Grabber/thumb (Godot default StyleBox) |
| **TabBar** | Tab backgrounds (selected/unselected/hover) | Close button icon (Godot default) |

### ScrollBar Detailed
- **Track**: AI-generated themed texture
- **Grabber/Thumb**: NOT AI-generated. Use Godot's default `grabber` StyleBox or simple `StyleBoxFlat` with theme color.

### ProgressBar Detailed
- **Track**: AI-generated themed texture (background StyleBox)
- **Fill**: NOT AI-generated. Runtime colored bar via ProgressBar.value property.

### TabBar Detailed
- **Tab backgrounds**: AI-generated (3 states: selected, unselected, hover)
- **Close button**: NOT AI-generated. Use Godot default icon or simple X symbol.

### Godot Theme Properties Populated

```gdscript
# ScrollBar
add_theme_stylebox_override("scroll", ai_generated_track_stylebox)
add_theme_stylebox_override("scroll_focus", ai_generated_track_stylebox)  # Reuse
add_theme_stylebox_override("grabber", StyleBoxFlat.new())  # Default colored box
add_theme_stylebox_override("grabber_highlight", StyleBoxFlat.new())  # Slightly brighter
add_theme_stylebox_override("grabber_pressed", StyleBoxFlat.new())  # Darker

# ProgressBar
add_theme_stylebox_override("background", ai_generated_track_stylebox)
# Fill is handled by ProgressBar internally via value property

# TabBar
add_theme_stylebox_override("tab_selected", ai_generated_selected_stylebox)
add_theme_stylebox_override("tab_unselected", ai_generated_unselected_stylebox)
add_theme_stylebox_override("tab_hovered", ai_generated_hover_stylebox)
# Close icon uses Godot default or simple vector
```

---

## Amendment 5: Reference Integrity Corrections

### Removed Invalid References
- ❌ `.sisyphus/notepads/asset-variations-plan/issues.md` (doesn't exist)
- ✅ `debug-output/ui-button-test/REPORT.md` (does exist, shows POC test format)

### Line Number References Removed
All specific line number references (e.g., `:145-152`) removed from plan. References now use file path + description only.

**Example**:
- ❌ Before: `api/src/ai/pipeline/types.ts:145-152` 
- ✅ After: `api/src/ai/pipeline/types.ts` - UIComponentSheetSpec definition

---

## Amendment 6: Control Dimensions Reference Table

| Control | Width | Height | Rationale |
|---------|-------|--------|-----------|
| Button | 256 | 256 | Square (POC standard) |
| CheckBox | 256 | 256 | Square (POC standard) |
| Panel | 256 | 256 | Square frame |
| ProgressBar | 256 | 64 | Wide horizontal bar |
| ScrollBar H | 256 | 32 | Slim horizontal track |
| ScrollBar V | 32 | 256 | Slim vertical track |
| TabBar | 128 | 48 | Moderate width, low height tab |

### Usage in Pipeline
```typescript
const controlDimensions: Record<UIComponentType, { width: number; height: number }> = {
  button: { width: 256, height: 256 },
  checkbox: { width: 256, height: 256 },
  panel: { width: 256, height: 256 },
  progress_bar: { width: 256, height: 64 },
  scroll_bar_h: { width: 256, height: 32 },
  scroll_bar_v: { width: 32, height: 256 },
  tab_bar: { width: 128, height: 48 },
};
```

---

## How to Use These Amendments

1. **Read this document FIRST**
2. **Apply amendments mentally** when reading the main plan
3. **Key changes**:
   - Task 1: Add state union expansion
   - Tasks 3-6: Use width/height parameters
   - Task 8: Pass dimensions to generators
   - Task 9: Clarify multi-part asset strategy
   - Task 12: Document synchronous execution model

These amendments resolve all critical issues identified by Momus. The plan is now implementation-ready.

