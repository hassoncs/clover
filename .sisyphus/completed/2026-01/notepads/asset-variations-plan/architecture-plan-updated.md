# Asset Sheet Architecture - Comprehensive Plan (Updated)

**Generated by:** ultrabrain planning agent + user feedback integration  
**Session:** ses_4113e03ffffeud72Q9MYI01p9C  
**Date:** 2026-01-23

---

## Executive Summary

Treat **everything that is "one image containing many usable sub-images"** as a single `AssetSheet` (atlas PNG + deterministic metadata JSON). Sprite sheets, tile sheets, and variation sheets become three `kind`s over the same core model, and `AssetPackV2` binds templates to either a single `GameAsset` or a `sheet entry` within an `AssetSheet`.

**Key Addition from User Feedback:** Per-entry prompt overrides with long-form descriptions alongside a base prompt.

---

## 1) Data Model - Core Concept

```
AssetSheet = atlas PNG + layout + entries + per-kind semantics + prompt overrides
```

### TypeScript Types (shared/src/types/asset-sheet.ts)

```typescript
export type AssetSheetKind = "sprite" | "tile" | "variation";

// Layout options
export type SheetLayout =
  | { type: "grid"; columns: number; rows: number; cellWidth: number; cellHeight: number; spacing?: number; margin?: number; origin?: "top-left" }
  | { type: "strip"; direction: "horizontal" | "vertical"; frameCount: number; cellWidth: number; cellHeight: number; spacing?: number; margin?: number; }
  | { type: "manual"; };

// How to address a region within the atlas
export type SheetRegion =
  | { type: "gridIndex"; index: number }
  | { type: "rect"; x: number; y: number; w: number; h: number };

// Shared "named region" that sprite/tile/variation all use
export interface AssetSheetEntry {
  id: string;              // stable key (e.g. "run_0", "brick/red", "tile:17")
  region: SheetRegion;
  pivot?: SheetPivot;
  tags?: string[];
  
  // === NEW: Per-entry prompt override ===
  // If present, this overrides the base prompt for this specific entry
  // Supports long-form descriptions for detailed variations
  promptOverride?: string;
}

// Sprite semantics
export interface SheetAnimation {
  id: string;
  frames: string[];        // array of AssetSheetEntry.id
  fps: number;
  loop?: boolean;
}

// Tile semantics
export interface TileMetadata {
  name?: string;
  tags?: string[];
  collision?: "none" | "full" | "platform" | { polygon: { x: number; y: number }[] };
  animation?: { frames: number[]; fps: number; loop?: boolean };
  
  // === NEW: Per-tile prompt override ===
  promptOverride?: string;
}

// Variation semantics
export interface VariationGroup {
  id: string;
  variants: Record<
    string, // variantKey: "red", "blue", "ice", "gold"
    {
      entryId: string;
      tags?: string[];
      weight?: number;
      
      // === NEW: Per-variant prompt override ===
      // Supports long-form descriptions for detailed variations
      promptOverride?: string;
    }
  >;
}

// === NEW: Prompt configuration ===
export interface SheetPromptConfig {
  // The base prompt applied to ALL entries (unless overridden)
  basePrompt: string;
  
  // Optional: modifiers appended to all prompts
  commonModifiers?: string[];
  
  // Optional: style preset (can affect model selection)
  stylePreset?: string;
  
  // Optional: negative prompt applied to all entries
  negativePrompt?: string;
}

// The main AssetSheet type (discriminated union)
export type AssetSheet =
  | (AssetSheetBase & { 
      kind: "sprite"; 
      promptConfig?: SheetPromptConfig;  // === NEW ===
      animations?: Record<string, SheetAnimation>; 
      defaultAnimationId?: string; 
    })
  | (AssetSheetBase & { 
      kind: "tile"; 
      promptConfig?: SheetPromptConfig;  // === NEW ===
      tileWidth: number; 
      tileHeight: number; 
      tiles?: Record<number, TileMetadata>; 
    })
  | (AssetSheetBase & { 
      kind: "variation"; 
      promptConfig?: SheetPromptConfig;  // === NEW ===
      groups: Record<string, VariationGroup>; 
      defaultGroupId?: string; 
      defaultVariantKey?: string; 
    });
```

### Example: Sprite Sheet with Per-Frame Overrides

```typescript
const spriteSheet: AssetSheet = {
  id: "hero_walk",
  kind: "sprite",
  layout: { type: "grid", columns: 4, rows: 2, cellWidth: 128, cellHeight: 128 },
  entries: {
    "idle_0": { id: "idle_0", region: { type: "gridIndex", index: 0 } },
    "idle_1": { id: "idle_1", region: { type: "gridIndex", index: 1 } },
    "run_0":  { id: "run_0",  region: { type: "gridIndex", index: 2 } },
    // Override: this frame needs a slightly different pose
    "run_1":  { 
      id: "run_1",  
      region: { type: "gridIndex", index: 3 },
      promptOverride: "Knight in mid-stride, right leg forward, left leg back, armor glinting in sunlight, dusty cape flowing backward"
    },
    "run_2":  { id: "run_2",  region: { type: "gridIndex", index: 4 } },
    // Override: add special effect to this frame
    "run_3":  { 
      id: "run_3",  
      region: { type: "gridIndex", index: 5 },
      promptOverride: "Knight running with glowing blue magic aura surrounding the sword, particles trailing behind"
    },
    // ... more frames
  },
  promptConfig: {
    basePrompt: "Fantasy knight character, 16-bit pixel art style, consistent proportions, same outfit and equipment throughout",
    commonModifiers: ["transparent background", "flat colors", "no anti-aliasing"],
    negativePrompt: "no text, no watermark, no border, no grid lines"
  },
  animations: {
    "idle": { id: "idle", frames: ["idle_0", "idle_1"], fps: 4, loop: true },
    "run":  { id: "run",  frames: ["run_0", "run_1", "run_2", "run_3"], fps: 12, loop: true }
  }
};
```

### Example: Variation Sheet with Per-Variant Descriptions

```typescript
const variationSheet: AssetSheet = {
  id: "breakout_bricks",
  kind: "variation",
  layout: { type: "grid", columns: 8, rows: 1, cellWidth: 64, cellHeight: 32 },
  entries: {
    "brick_0": { id: "brick_0", region: { type: "gridIndex", index: 0 } },
    "brick_1": { id: "brick_1", region: { type: "gridIndex", index: 1 } },
    // ... all bricks
  },
  promptConfig: {
    basePrompt: "Classic breakout brick, rectangular shape with beveled edges and subtle 3D depth, clean design",
    negativePrompt: "no text, no numbers, no letters"
  },
  groups: {
    "brick": {
      id: "brick",
      variants: {
        "red": { 
          entryId: "brick_0",
          promptOverride: "Fiery red brick with glowing ember texture, cracks glowing orange, intense heat visual"  // === LONG DESCRIPTION ===
        },
        "orange": { 
          entryId: "brick_1",
          promptOverride: "Warm orange brick, gradient from bright tangerine to deep amber, subtle flame motif at center"  // === LONG DESCRIPTION ===
        },
        "yellow": { 
          entryId: "brick_2",
          promptOverride: "Golden yellow brick, shiny metallic gold finish with reflective highlights"  // === LONG DESCRIPTION ===
        },
        "green": { 
          entryId: "brick_3",
          promptOverride: "Emerald green brick, gem-like appearance with internal light refraction effect"  // === LONG DESCRIPTION ===
        },
        // ... more variants - could use base prompt if no override needed
        "blue":  { entryId: "brick_4" },      // Uses base prompt
        "purple": { entryId: "brick_5" },     // Uses base prompt
        // ...
      }
    }
  }
};
```

### Example: Tile Sheet with Per-Tile Overrides

```typescript
const tileSheet: AssetSheet = {
  id: "platform_tiles",
  kind: "tile",
  layout: { type: "grid", columns: 8, rows: 8, cellWidth: 32, cellHeight: 32 },
  promptConfig: {
    basePrompt: "Platformer game tiles, pixel art, consistent lighting from top-left, seamless edges",
    negativePrompt: "no text, no labels, no border"
  },
  tileWidth: 32,
  tileHeight: 32,
  tiles: {
    0: { name: "grass_top", collision: "platform" },
    1: { name: "grass_dirt", collision: "full" },
    // ...
    15: { 
      name: "coin_rare", 
      collision: "none",
      promptOverride: "Shiny golden coin with dollar sign, spinning animation suggestion, magical glow effect around edges"  // === LONG DESCRIPTION ===
    },
    // ...
  }
};
```

---

## 2) Prompt Strategy - With Overrides

### Generation Flow (per entry)

For each entry in the sheet:

1. **Start with base prompt** from `promptConfig.basePrompt`
2. **Append common modifiers** from `promptConfig.commonModifiers`
3. **Check for override** on this specific entry:
   - If `entry.promptOverride` exists → use it (completely replaces base)
   - Otherwise → use base prompt
4. **Append negative prompt** from `promptConfig.negativePrompt` (if any)

### Code: Prompt Building Logic

```typescript
// api/src/ai/pipeline/prompt-builder.ts

interface BuildSheetPromptParams {
  entryId: string;
  entry: AssetSheetEntry;
  kind: "sprite" | "tile" | "variation";
  promptConfig?: SheetPromptConfig;
  theme?: string;
  style?: SpriteStyle;
  // For variations: the variant metadata
  variantOverride?: { promptOverride?: string };
  // For tiles: the tile metadata
  tileMetadata?: { promptOverride?: string };
}

export function buildSheetEntryPrompt(params: BuildSheetPromptParams): string {
  const lines: string[] = [];
  
  // === CAMERA/VIEW (for sprite sheets) ===
  if (params.kind === "sprite") {
    lines.push("=== CAMERA/VIEW (CRITICAL) ===");
    lines.push("FRONT VIEW. Flat 2D. No perspective. Consistent camera and scale.");
  }
  
  // === OUTPUT FORMAT ===
  lines.push("=== OUTPUT FORMAT (CRITICAL) ===");
  lines.push("SINGLE SPRITE/TILE/VARIANT (one cell from a sheet).");
  lines.push("NO borders, NO grid lines, NO labels, NO text.");
  
  // === SUBJECT ===
  lines.push("=== SUBJECT ===");
  
  // Check for override (priority order: tile > variant > entry)
  const override = 
    params.tileMetadata?.promptOverride ||
    params.variantOverride?.promptOverride ||
    params.entry.promptOverride;
  
  if (override) {
    // Use the long-form override description
    lines.push(override);
  } else if (params.promptConfig?.basePrompt) {
    // Use base prompt
    lines.push(params.promptConfig.basePrompt);
  } else {
    // Fallback to existing entity-style prompt building
    lines.push(buildEntityPrompt(...));
  }
  
  // === THEME/STYLE ===
  if (params.theme) {
    lines.push(`Style: ${params.theme}`);
  }
  if (params.style) {
    lines.push(`Art style: ${params.style}`);
  }
  
  // === TECHNICAL ===
  lines.push("=== TECHNICAL ===");
  lines.push("Transparent background (alpha channel).");
  
  // Common modifiers
  if (params.promptConfig?.commonModifiers) {
    lines.push(...params.promptConfig.commonModifiers);
  }
  
  // Negative prompt
  if (params.promptConfig?.negativePrompt) {
    lines.push(`NEGATIVE: ${params.promptConfig.negativePrompt}`);
  }
  
  return lines.join("\n");
}
```

### Example: Generated Prompt for Overridden Brick

**Input:**
```typescript
{
  entryId: "brick_red",
  entry: { 
    id: "brick_red", 
    region: { type: "gridIndex", index: 0 },
    promptOverride: "Fiery red brick with glowing ember texture, cracks glowing orange, intense heat visual"
  },
  promptConfig: {
    basePrompt: "Classic breakout brick, rectangular shape with beveled edges and subtle 3D depth, clean design",
    commonModifiers: ["flat colors", "pixel perfect"],
    negativePrompt: "no text, no numbers, no letters"
  }
}
```

**Output:**
```
=== OUTPUT FORMAT (CRITICAL) ===
SINGLE SPRITE/TILE/VARIANT (one cell from a sheet).
NO borders, NO grid lines, NO labels, NO text.

=== SUBJECT ===
Fiery red brick with glowing ember texture, cracks glowing orange, intense heat visual

=== TECHNICAL ===
Transparent background (alpha channel).
flat colors
pixel perfect
NEGATIVE: no text, no numbers, no letters
```

---

## 3) Pipeline Design - With Overrides

### Pipeline Type Additions

```typescript
export type AssetType = "entity" | "background" | "title_hero" | "parallax" | "sheet";
export type SheetKind = "sprite" | "tile" | "variation";

export interface SheetSpecBase {
  type: "sheet";
  id: string;
  kind: SheetKind;
  layout: SheetLayout;
  width?: number;
  height?: number;
  promptConfig?: SheetPromptConfig;  // === NEW ===
  
  // === NEW: Entry-specific prompt overrides ===
  // Map of entryId -> promptOverride
  entryOverrides?: Record<string, string>;
}

export interface SpriteSheetSpec extends SheetSpecBase {
  kind: "sprite";
  animations: Record<string, { frames: string[]; fps: number; loop?: boolean }>;
  // Entry IDs that have overrides
  entryOverrides?: Record<string, string>;
}

export interface VariationSheetSpec extends SheetSpecBase {
  kind: "variation";
  variants: Array<{ key: string; description?: string; promptOverride?: string }>;
}

export interface TileSheetSpec extends SheetSpecBase {
  kind: "tile";
  tileWidth: number;
  tileHeight: number;
  // Tile index -> prompt override
  tileOverrides?: Record<number, string>;
}
```

### Stage Graph for Sheets (Updated)

1. `sheet-guide` - Generate guide PNG with grid (no silhouettes per-cell)
2. `build-prompt` - For each entry, build prompt with override support
3. `upload-scenario` - Upload guide
4. `img2img` - Generate (for sprite/variation sheets)
   - **NEW:** For each entry with override, could run separate img2img? 
   - **OR:** Single img2img for entire sheet, overrides affect prompt interpretation
   - Recommendation: Start with single img2img for consistency, allow per-entry later
5. `remove-bg` (optional/fallback)
6. `build-sheet-metadata` - Deterministic JSON from spec
7. `upload-r2` - Upload both PNG and JSON

### Advanced: Per-Entry Generation (Future Enhancement)

For cases where overrides differ dramatically:

```typescript
// Future: Multi-pass generation for sheets with heavy overrides
interface MultiPassSheetSpec extends SheetSpecBase {
  generationStrategy: "single-pass" | "multi-pass";
  
  // For multi-pass: group entries by similar prompt
  passGroups?: Array<{
    name: string;
    entryIds: string[];
    promptOverride?: string;
  }>;
}
```

---

## 4) File Modification Map (Updated)

### Shared Types/Schemas
| File | Change |
|------|--------|
| `shared/src/types/asset-sheet.ts` | NEW: Full AssetSheet model with promptConfig and promptOverride |
| `shared/src/types/index.ts` | Export new module |
| `shared/src/types/schemas.ts` | Add SheetPromptConfigSchema, update AssetSheetSchema |
| `shared/src/types/asset-system.ts` | Integrate AssetBinding |

### API Pipeline
| File | Change |
|------|--------|
| `api/src/ai/pipeline/types.ts` | Add sheet types with promptConfig and entryOverrides |
| `api/src/ai/pipeline/registry.ts` | Add stage list for "sheet" |
| `api/src/ai/pipeline/prompt-builder.ts` | Add `buildSheetEntryPrompt()` with override logic |
| `api/src/ai/pipeline/stages/index.ts` | Add `sheet-guide` and `build-sheet-metadata` stages |

---

## 5) Implementation Sequence (Recommended)

1. **Add shared types/schemas** - AssetSheet, SheetPromptConfig, promptOverride on entries
2. **Extend pipeline types** - Add promptConfig and entryOverrides to sheet specs
3. **Add prompt builder function** - `buildSheetEntryPrompt()` with override resolution
4. **Add sheet guide stage** - Generate grid guide PNG
5. **Add metadata build stage** - Deterministic JSON from spec
6. **Extend upload-r2** - Upload both PNG and JSON
7. **Extend AssetPackV2** - Support sheet binding in entries
8. **Add editor UI** - Allow users to set base prompt + per-entry overrides
9. **Add runtime consumption** - Atlas region rendering and animation setup

---

## 6) Example: User Experience in Editor

```
┌─────────────────────────────────────────────────────────────────┐
│  Sprite Sheet: Knight Walk Cycle                                 │
├─────────────────────────────────────────────────────────────────┤
│  Layout: 4×2 grid, 128×128 cells, 8px spacing                   │
│                                                                 │
│  ┌───────┬───────┬───────┬───────┐                              │
│  │ idle_0│ idle_1│ run_0 │ run_1 │ ← run_1 has override         │
│  │       │       │       │ *     │   "Knight mid-stride..."     │
│  ├───────┼───────┼───────┼───────┤                              │
│  │ run_2 │ run_3 │ jump_0│ jump_1│ ← run_3 has override         │
│  │       │       │       │ *     │   "Knight with magic aura"   │
│  └───────┴───────┴───────┴───────┘                              │
│                                                                 │
│  Base Prompt:                                                   │
│  "Fantasy knight, 16-bit pixel art, consistent proportions"     │
│                                                                 │
│  [Edit Override for run_1] [Edit Override for run_3]            │
│                                                                 │
│  Common Modifiers: transparent bg, flat colors, no AA           │
│  Negative Prompt: no text, no watermark, no border              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7) Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Background removal breaks sheets | Skip remove-bg for sheets; prompt for alpha explicitly |
| Inconsistent AI generation across frames | Use grid guide image + consistent base prompt |
| Overrides make AI confused | Guide image helps; clear separation between entries |
| Per-entry generation too slow | Start with single img2img; add multi-pass later if needed |

---

*This updated plan incorporates user feedback: per-entry prompt overrides with long-form descriptions alongside base prompts, applicable to all sheet kinds.*
