# Godot UI Theming System - Critical Amendments

## Context
This document clarifies implementation details in response to Momus review. Read this BEFORE `.sisyphus/plans/godot-ui-theming-system.md`.

---

## Amendment 1: State Type System Expansion

### Current Type Constraint (in repo)
```typescript
// api/src/ai/pipeline/types.ts
states: Array<'normal' | 'hover' | 'pressed' | 'disabled' | 'focus'>;
```

### MUST CHANGE TO
```typescript
states: Array<'normal' | 'hover' | 'pressed' | 'disabled' | 'focus' | 'selected' | 'unselected'>;
```

### Rationale
TabBar requires `selected` and `unselected` states. Without this type expansion, Task 1 will fail TypeScript compilation.

### Implementation Note
Task 1 MUST include this type union expansion as first step.

---

## Amendment 2: Non-Square Control Dimensions

### Problem
- ProgressBar: 256√ó64 (not square)
- ScrollBar H: 256√ó32 (not square)
- ScrollBar V: 32√ó256 (not square)
- TabBar: 128√ó48 (not square)

Current pipeline assumes square `canvasSize`.

### Solution
Use existing `SheetSpecBase.width` and `height` fields:

```typescript
// api/src/ai/pipeline/types.ts - ALREADY EXISTS
export interface SheetSpecBase {
  type: 'sheet';
  id: string;
  kind: SheetKind;
  layout: SheetLayout;
  width?: number;    // ‚Üê USE THIS
  height?: number;   // ‚Üê USE THIS
  // ...
}
```

### Implementation Changes

**Task 3-6 (Silhouette Generators)**:
- Accept `{ width, height }` parameters (not just `canvasSize`)
- Return appropriately sized PNG buffers

**Task 8 (Pipeline Stages)**:
- Pass `spec.width` and `spec.height` to silhouette generators
- Store actual dimensions in metadata (not assumed square)

**Metadata Format**:
```json
{
  "componentType": "progress_bar",
  "width": 256,
  "height": 64,
  "states": {
    "normal": { "region": { "x": 0, "y": 0, "width": 256, "height": 64 }, "r2Key": "..." }
  },
  "ninePatchMargins": { "left": 8, "right": 8, "top": 8, "bottom": 8 }
}
```

---

## Amendment 3: Batch API Execution Model

### Current POC Pattern
```typescript
// api/src/trpc/routes/ui-components.ts (POC)
generateUIComponent: async ({ input }) => {
  // Creates pack in DB
  // Returns job ID
  // User calls processUIComponentJob separately (async)
}
```

### This Plan Uses: SYNCHRONOUS Generation

**Rationale**: <5 minute total generation time is acceptable for synchronous HTTP response.

```typescript
generateUITheme: async ({ input }) => {
  const results = [];
  
  // Sequential, synchronous generation
  for (const controlType of input.controls) {
    const result = await executeGameAssets(/*...*/);  // BLOCKING
    results.push(result);
  }
  
  return { results };  // All done, return immediately
}
```

**Trade-offs**:
- ‚úÖ Simpler (no job polling)
- ‚úÖ Immediate results
- ‚ùå HTTP timeout risk if >5 minutes (acceptable given 6 controls √ó ~30-40s each = ~4 minutes max)

**If timeout becomes issue**: Switch to job-based model later (out of scope for this plan).

---

## Amendment 4: Multi-Part Control Asset Strategy

### Clarification: What Gets Generated

| Control | Generated by Plan | Not Generated (Use Godot Defaults) |
|---------|-------------------|-----------------------------------|
| **Panel** | Frame background (hollow) | N/A |
| **ProgressBar** | Track background | Fill bar (runtime color) |
| **ScrollBar** | Track background | Grabber/thumb (Godot default StyleBox) |
| **TabBar** | Tab backgrounds (selected/unselected/hover) | Close button icon (Godot default) |

### ScrollBar Detailed
- **Track**: AI-generated themed texture
- **Grabber/Thumb**: NOT AI-generated. Use Godot's default `grabber` StyleBox or simple `StyleBoxFlat` with theme color.

### ProgressBar Detailed
- **Track**: AI-generated themed texture (background StyleBox)
- **Fill**: NOT AI-generated. Runtime colored bar via ProgressBar.value property.

### TabBar Detailed
- **Tab backgrounds**: AI-generated (3 states: selected, unselected, hover)
- **Close button**: NOT AI-generated. Use Godot default icon or simple X symbol.

### Godot Theme Properties Populated

```gdscript
# ScrollBar
add_theme_stylebox_override("scroll", ai_generated_track_stylebox)
add_theme_stylebox_override("scroll_focus", ai_generated_track_stylebox)  # Reuse
add_theme_stylebox_override("grabber", StyleBoxFlat.new())  # Default colored box
add_theme_stylebox_override("grabber_highlight", StyleBoxFlat.new())  # Slightly brighter
add_theme_stylebox_override("grabber_pressed", StyleBoxFlat.new())  # Darker

# ProgressBar
add_theme_stylebox_override("background", ai_generated_track_stylebox)
# Fill is handled by ProgressBar internally via value property

# TabBar
add_theme_stylebox_override("tab_selected", ai_generated_selected_stylebox)
add_theme_stylebox_override("tab_unselected", ai_generated_unselected_stylebox)
add_theme_stylebox_override("tab_hovered", ai_generated_hover_stylebox)
# Close icon uses Godot default or simple vector
```

---

## Amendment 5: Reference Integrity Corrections

### Removed Invalid References
- ‚ùå `.sisyphus/notepads/asset-variations-plan/issues.md` (doesn't exist)
- ‚úÖ `debug-output/ui-button-test/REPORT.md` (does exist, shows POC test format)

### Line Number References Removed
All specific line number references (e.g., `:145-152`) removed from plan. References now use file path + description only.

**Example**:
- ‚ùå Before: `api/src/ai/pipeline/types.ts:145-152` 
- ‚úÖ After: `api/src/ai/pipeline/types.ts` - UIComponentSheetSpec definition

---

## Amendment 6: Control Dimensions Reference Table

| Control | Width | Height | Rationale |
|---------|-------|--------|-----------|
| Button | 256 | 256 | Square (POC standard) |
| CheckBox | 256 | 256 | Square (POC standard) |
| Panel | 256 | 256 | Square frame |
| ProgressBar | 256 | 64 | Wide horizontal bar |
| ScrollBar H | 256 | 32 | Slim horizontal track |
| ScrollBar V | 32 | 256 | Slim vertical track |
| TabBar | 128 | 48 | Moderate width, low height tab |

### Usage in Pipeline
```typescript
const controlDimensions: Record<UIComponentType, { width: number; height: number }> = {
  button: { width: 256, height: 256 },
  checkbox: { width: 256, height: 256 },
  panel: { width: 256, height: 256 },
  progress_bar: { width: 256, height: 64 },
  scroll_bar_h: { width: 256, height: 32 },
  scroll_bar_v: { width: 32, height: 256 },
  tab_bar: { width: 128, height: 48 },
};
```

---

## How to Use These Amendments

1. **Read this document FIRST**
2. **Apply amendments mentally** when reading the main plan
3. **Key changes**:
   - Task 1: Add state union expansion
   - Tasks 3-6: Use width/height parameters
   - Task 8: Pass dimensions to generators
   - Task 9: Clarify multi-part asset strategy
   - Task 12: Document synchronous execution model

These amendments resolve all critical issues identified by Momus. The plan is now implementation-ready.

# Godot UI Theming System - Complete Implementation Plan

## Context

### Original Request
User wants to plan a holistic UI theming system connecting the game engine, AI-generated assets (Scenario.com), and Godot's theming framework (StyleBoxTexture, nine-patch rendering). The goal is to generate themed UI components for games that look cohesive and professional.

### Interview Summary

**Key Discussions**:
- **Scope**: Extend existing Button/CheckBox POC to 4 additional controls:
  - ‚úÖ Button (POC done)
  - ‚úÖ CheckBox (POC done)
  - üÜï Panel
  - üÜï ProgressBar
  - üÜï ScrollBar (Horizontal + Vertical as separate types)
  - üÜï TabBar

- **Icon Strategy**: Post-generation overlay approach (separate from backgrounds)
  - Allows flexibility to experiment with embedded symbols later
  - CheckBox checkmark, ScrollBar arrows, TabBar close button as overlays
  - Code designed to switch to embedded generation if needed

- **Nine-Patch Margins**: Hardcoded per control type
  - Button/CheckBox: 12px (POC standard)
  - Panel: 16px (chunkier decorative frames)
  - ProgressBar: 8px (thin borders)
  - ScrollBar: 8px (compact)
  - TabBar: 12px (moderate borders)

- **Theme Generation**: Flexible batch API
  - `generateUITheme({ theme: string, controls: string[] })`
  - Can generate all 6 controls at once or any subset
  - Sequential generation for consistency

- **Godot Architecture**: Extend generic ThemedUIComponent.gd
  - Add PANEL, PROGRESS_BAR, SCROLL_BAR_H, SCROLL_BAR_V, TAB_BAR to enum
  - Single component handles all control types via switch/case

- **Panel Structure**: Hollow frame (transparent center)
  - Not a filled background - true panel aesthetic
  - Requires new SVG silhouette generation logic

- **State Models per Control**:
  - Panel: `normal` only (1 state)
  - ProgressBar: `normal`, `disabled` (2 states)
  - ScrollBar: `normal`, `hover`, `pressed` (3 states)
  - TabBar: `selected`, `unselected`, `hover` (3 states)

**Research Findings**:
- ‚úÖ POC Complete: `.sisyphus/completed/2026-01/ui-component-generation.md`
- ‚úÖ Type system supports `UIComponentSheetSpec` in `api/src/ai/pipeline/types.ts`
- ‚úÖ Pipeline stages: silhouette ‚Üí img2img (base @ 0.95, variations @ 0.7) ‚Üí R2 ‚Üí metadata
- ‚úÖ Godot integration: `ThemedUIComponent.gd` loads textures + creates StyleBoxTexture
- ‚úÖ Bridge: `GameBridge.gd` exposes `createUIButton()` - needs extension

### Metis Review

**Critical Gaps Identified**:
1. **Silhouette Complexity**: Panel needs hollow center (frame only), not filled rectangle
2. **State Mapping**: Each control type needs custom state model (not all use normal/hover/pressed/disabled)
3. **Embedded Symbols**: Need strategy for checkmarks/arrows (decided: post-generation overlay)
4. **ScrollBar Variants**: H/V handling (decided: separate component types)
5. **TabBar Layout**: Single tab texture vs multi-tab sprite sheet (decided: single tab, Godot tiles)
6. **Cross-Control Consistency**: No mechanism to enforce theme coherence (accept as limitation)

**Guardrails Applied**:
- ‚ùå No animated states (static textures only)
- ‚ùå No theme persistence/saving (theme is input parameter)
- ‚ùå No user-configurable margins (hardcoded constants)
- ‚ùå No regeneration UI (one-shot generation)
- ‚ùå No composite controls (e.g., Dropdown = Button + Panel)
- ‚ùå No accessibility features (out of scope)
- ‚ùå No cross-control consistency enforcement (each generated independently)
- ‚ùå Only 4 new controls (Panel, ProgressBar, ScrollBar H/V, TabBar)

---

## Work Objectives

### Core Objective
Extend the UI component generation system from 2 controls (Button, CheckBox) to 6+ controls (adding Panel, ProgressBar, ScrollBar H/V, TabBar) with SVG-based silhouette generation for complex shapes.

### Concrete Deliverables

1. **Type System Extensions** (`api/src/ai/pipeline/types.ts`):
   - Add control types: `panel`, `progress_bar`, `scroll_bar_h`, `scroll_bar_v`, `tab_bar`
   - Define state arrays per control type
   - Define margin constants per control type

2. **SVG Silhouette Generators** (`api/src/ai/pipeline/silhouettes/ui-component-svg.ts`):
   - `createPanelSilhouette()` - Hollow frame with transparent center
   - `createProgressBarSilhouette()` - Track with end caps
   - `createScrollBarSilhouette(orientation)` - Track shape (H or V)
   - `createTabBarSilhouette()` - Single tab shape

3. **Prompt Builder Extensions** (`api/src/ai/pipeline/prompt-builder.ts`):
   - Control-specific prompt variations
   - State-specific descriptions per control type

4. **Pipeline Stage Updates** (`api/src/ai/pipeline/stages/ui-component.ts`):
   - Handle new control types in base/variation stages
   - Multi-part metadata (e.g., ScrollBar track + thumb)

5. **Godot Component Extensions** (`godot_project/scripts/ui/ThemedUIComponent.gd`):
   - Add PANEL, PROGRESS_BAR, SCROLL_BAR_H, SCROLL_BAR_V, TAB_BAR to enum
   - Node instantiation: `Panel.new()`, `ProgressBar.new()`, `HScrollBar.new()`, `VScrollBar.new()`, `TabBar.new()`
   - StyleBox application per node type

6. **GameBridge Methods** (`godot_project/scripts/GameBridge.gd`):
   - Add `createUIPanel(id, x, y, w, h, metadata_url)`
   - Add `createUIProgressBar(id, x, y, w, h, metadata_url)`
   - Add `createUIScrollBar(id, orientation, x, y, w, h, metadata_url)`
   - Add `createUITabBar(id, x, y, w, h, tab_count, metadata_url)`

7. **Batch API** (`api/src/trpc/routes/ui-components.ts`):
   - Extend `generateUIComponent` to accept array of control types
   - `generateUITheme({ theme, controls: string[] })` mutation

8. **Test Scenes** (`godot_project/scenes/test_ui_theme.tscn`):
   - Showcase all 6 controls with same theme
   - Multiple sizes to verify nine-patch stretch
   - Interactive test (hover, click, scroll)

### Definition of Done
- [ ] All 6 control types generate themed backgrounds
- [ ] Panel has transparent center (hollow frame)
- [ ] ProgressBar track tiles horizontally
- [ ] ScrollBar H and V variants both work
- [ ] TabBar selected/unselected states are visually distinct
- [ ] Batch API generates all 6 controls from single call
- [ ] Godot test scene shows all 6 controls themed consistently
- [ ] Generation time <5 minutes for full theme (6 controls)
- [ ] All TypeScript compiles without errors (`tsc --noEmit`)
- [ ] Manual QA: All controls look themed and visually coherent

### Must Have
- SVG silhouette generation for complex shapes (hollow Panel, capped ProgressBar)
- Control-specific state models (not all use normal/hover/pressed/disabled)
- Separate ScrollBar H/V types
- Post-generation overlay for symbols (checkmarks, arrows)
- Batch generation API
- Extended ThemedUIComponent.gd for all control types
- Godot test scene for manual QA

### Must NOT Have (Guardrails)

**POC Extension Boundaries**:
- ‚ùå Other control types (LineEdit, Tree, ItemList, PopupMenu, Window, Tooltip)
- ‚ùå Animated state transitions
- ‚ùå Theme persistence/saving UI
- ‚ùå Regeneration workflow UI
- ‚ùå Multiple style variants per theme
- ‚ùå Composite controls (Dropdown, ComboBox, etc.)
- ‚ùå User-configurable nine-patch margins
- ‚ùå Automatic margin detection (edge detection, ML)
- ‚ùå Cross-control style consistency enforcement
- ‚ùå Accessibility features (ARIA, screen reader)

**AI-Slop Patterns to Avoid**:
- ‚ùå Over-abstraction: No `ControlShapeFactory` with plugin system for 6 controls
- ‚ùå Scope inflation: No additional control types beyond the 6 agreed upon
- ‚ùå Premature optimization: No caching layer for silhouettes or assets
- ‚ùå Feature creep: No theme editing UI, no theme gallery, no theme marketplace
- ‚ùå Over-engineering: No DSL for silhouette shapes, no complex layout system

---

## Verification Strategy

### Manual QA with Screenshots

Each task includes detailed manual verification procedures.

**By Deliverable Type**:

| Type | Verification Tool | Procedure |
|------|------------------|-----------|
| **TypeScript Types** | tsc --noEmit | Compile check, zero errors |
| **SVG Silhouette** | Node script + image viewer | Generate test silhouette, visually inspect shape |
| **Image Generation** | Scenario.com + R2 | Generate, download, verify themed appearance |
| **Godot Component** | Godot editor + runtime | Load test scene, interact with controls |
| **API/tRPC** | curl / Postman | Send batch request, verify all controls generated |

**Evidence Required**:
- Screenshots of all 6 controls in normal state
- Screenshots of interactive states (hover, pressed, disabled)
- Screenshot of hollow Panel center (transparency verification)
- Screenshots of nine-patch stretch at 2x, 3x sizes
- Terminal output of successful batch generation
- Godot console output (no errors)

---

## Task Flow

```
Phase 1: Type System & Constants
  Task 1 (Types) ‚Üí Task 2 (Constants)

Phase 2: SVG Silhouette Generation
  Task 3 (Panel) ‚îê
  Task 4 (ProgressBar) ‚îú‚îÄ‚Üí All parallel (independent)
  Task 5 (ScrollBar) ‚î§
  Task 6 (TabBar) ‚îò
  ‚Üì
  Checkpoint: Generate test silhouettes, visually inspect

Phase 3: Prompt & Pipeline
  Task 7 (Prompt Builder) ‚Üí Task 8 (Pipeline Stages)

Phase 4: Godot Integration
  Task 9 (ThemedUIComponent) ‚Üí Task 10 (GameBridge) ‚Üí Task 11 (Test Scene)

Phase 5: Batch API & QA
  Task 12 (Batch API) ‚Üí Task 13 (Manual QA)
```

## Parallelization

| Group | Tasks | Reason |
|-------|-------|--------|
| A | 3, 4, 5, 6 | Independent silhouette generators |

| Task | Depends On | Reason |
|------|------------|--------|
| 2 | 1 | Needs type definitions |
| 7 | 1, 3, 4, 5, 6 | Needs types + silhouette functions |
| 8 | 7 | Needs prompt builder |
| 9 | 1, 2 | Needs types + constants |
| 10 | 9 | Needs ThemedUIComponent enum |
| 11 | 10 | Needs GameBridge methods |
| 12 | 1, 8 | Needs types + pipeline stages |
| 13 | All | Final verification |

---

## TODOs


- [ ] 1. Extend Type System for New Controls

  **What to do**:
  - Update `api/src/ai/pipeline/types.ts`:
    - Add to `componentType` union: `'panel' | 'progress_bar' | 'scroll_bar_h' | 'scroll_bar_v' | 'tab_bar'`
    - Create state model constants:
      ```typescript
      export const UI_COMPONENT_STATES: Record<UIComponentType, string[]> = {
        button: ['normal', 'hover', 'pressed', 'disabled'],
        checkbox: ['normal', 'hover', 'pressed', 'disabled'],
        panel: ['normal'],
        progress_bar: ['normal', 'disabled'],
        scroll_bar_h: ['normal', 'hover', 'pressed'],
        scroll_bar_v: ['normal', 'hover', 'pressed'],
        tab_bar: ['selected', 'unselected', 'hover'],
      };
      ```
    - Create margin constants:
      ```typescript
      export const UI_COMPONENT_MARGINS: Record<UIComponentType, NinePatchMargins> = {
        button: { left: 12, right: 12, top: 12, bottom: 12 },
        checkbox: { left: 12, right: 12, top: 12, bottom: 12 },
        panel: { left: 16, right: 16, top: 16, bottom: 16 },
        progress_bar: { left: 8, right: 8, top: 8, bottom: 8 },
        scroll_bar_h: { left: 8, right: 8, top: 8, bottom: 8 },
        scroll_bar_v: { left: 8, right: 8, top: 8, bottom: 8 },
        tab_bar: { left: 12, right: 12, top: 12, bottom: 12 },
      };
      ```

  **Must NOT do**:
  - Don't add more control types beyond the agreed 6
  - Don't make margins user-configurable (constants only)
  - Don't add animation-related fields

  **Parallelizable**: YES (with Task 2 database schema if needed)

  **References**:
  
  **Pattern References**:
  - `api/src/ai/pipeline/types.ts:145-152` - Current `UIComponentSheetSpec` definition
  - `api/src/ai/pipeline/silhouettes/ui-component.ts:22` - Current `UI_COMPONENT_MARGINS` constant

  **Type References**:
  - `api/src/ai/pipeline/types.ts:147` - `componentType` field to extend

  **WHY Each Reference Matters**:
  - Existing type structure shows pattern to follow
  - Constants approach matches POC

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0
  - [ ] Type union includes all 7 types (button, checkbox, panel, progress_bar, scroll_bar_h, scroll_bar_v, tab_bar)
  - [ ] Constants defined for states and margins
  - [ ] IntelliSense shows new types

  **Evidence Required**:
  - [ ] Terminal output: `tsc --noEmit` success
  - [ ] Code snippet showing new types in `types.ts`

  **Commit**: NO (groups with Task 2)

---

- [ ] 2. Define Control-Specific Constants and Helpers

  **What to do**:
  - Create `api/src/ai/pipeline/ui-control-config.ts`:
    - Export control config object:
      ```typescript
      export const UI_CONTROL_CONFIG = {
        panel: {
          states: ['normal'],
          margins: { left: 16, right: 16, top: 16, bottom: 16 },
          description: 'Decorative frame panel with hollow center',
        },
        progress_bar: {
          states: ['normal', 'disabled'],
          margins: { left: 8, right: 8, top: 8, bottom: 8 },
          description: 'Horizontal progress bar track',
        },
        scroll_bar_h: {
          states: ['normal', 'hover', 'pressed'],
          margins: { left: 8, right: 8, top: 8, bottom: 8 },
          description: 'Horizontal scrollbar track',
        },
        scroll_bar_v: {
          states: ['normal', 'hover', 'pressed'],
          margins: { left: 8, right: 8, top: 8, bottom: 8 },
          description: 'Vertical scrollbar track',
        },
        tab_bar: {
          states: ['selected', 'unselected', 'hover'],
          margins: { left: 12, right: 12, top: 12, bottom: 12 },
          description: 'Navigation tab background',
        },
      };
      ```
  - Add helper: `getControlConfig(type: UIComponentType)`

  **Must NOT do**:
  - Don't add configuration for controls outside the 6
  - Don't add runtime configuration (this is build-time config)

  **Parallelizable**: NO (depends on Task 1)

  **References**:
  
  **Pattern References**:
  - `api/src/ai/pipeline/types.ts` - Type definitions from Task 1

  **WHY Each Reference Matters**:
  - Centralizes control-specific configuration
  - Makes it easy to look up states/margins per control type

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0
  - [ ] Helper function returns correct config:
    ```typescript
    const config = getControlConfig('panel');
    console.log(config.states); // ['normal']
    console.log(config.margins); // { left: 16, ... }
    ```

  **Evidence Required**:
  - [ ] Terminal output: tsc success
  - [ ] Code snippet showing config usage

  **Commit**: YES (with Task 1)
  - Message: `feat(api): add type system for 6 UI control types`
  - Files: `api/src/ai/pipeline/types.ts`, `api/src/ai/pipeline/ui-control-config.ts`
  - Pre-commit: `cd api && tsc --noEmit`

---


- [ ] 3. Create Panel SVG Silhouette Generator (Hollow Frame)

  **What to do**:
  - Create `api/src/ai/pipeline/silhouettes/ui-component-svg.ts`:
  - Implement `createPanelSilhouette()`:
    - Canvas: 256x256 pixels
    - Frame structure:
      - Outer rectangle: Full canvas (256x256)
      - Inner rectangle: Inset by 16px margin (224x224 centered)
      - Fill: Outer is dark gray (#404040), inner is transparent
    - Use SVG path with "fill-rule: evenodd" for hollow effect:
      ```svg
      <svg width="256" height="256">
        <path fill-rule="evenodd" d="
          M 0 0 L 256 0 L 256 256 L 0 256 Z
          M 16 16 L 240 16 L 240 240 L 16 240 Z
        " fill="#404040" />
      </svg>
      ```
    - Convert SVG ‚Üí PNG buffer using library (research: `sharp` with SVG input, or `resvg-js`)

  **Must NOT do**:
  - Don't create filled rectangle (needs hollow center)
  - Don't use complex gradients (simple grayscale for AI guidance)
  - Don't add decorative details (AI will add theme)

  **Parallelizable**: YES (with Tasks 4, 5, 6)

  **References**:
  
  **Pattern References**:
  - `api/src/ai/pipeline/silhouettes/ui-component.ts:createNinePatchSilhouette` - Current PNG generation with sharp
  - SVG hollow path technique: Use fill-rule="evenodd" with overlapping paths

  **Library Research Needed**:
  - `sharp` supports SVG input: `sharp(Buffer.from(svgString))`
  - Alternative: `resvg-js` for more control

  **WHY Each Reference Matters**:
  - Current silhouette generator shows PNG buffer output pattern
  - SVG gives precise control over hollow frame structure
  - fill-rule="evenodd" creates "punch-through" effect

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Generate test silhouette with Node script:
    ```typescript
    import { createPanelSilhouette } from './api/src/ai/pipeline/silhouettes/ui-component-svg';
    import fs from 'fs';
    const buffer = await createPanelSilhouette({ width: 256, height: 256, margin: 16 });
    fs.writeFileSync('test-panel-silhouette.png', buffer);
    ```
  - [ ] Open `test-panel-silhouette.png` in image viewer
  - [ ] Verify:
    - Outer frame is dark gray
    - Center is transparent (checkerboard visible in viewer)
    - Frame width is 16px
    - Dimensions are 256x256
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0

  **Evidence Required**:
  - [ ] Screenshot of generated silhouette (showing transparency)
  - [ ] Terminal output: tsc success
  - [ ] File size check: `ls -lh test-panel-silhouette.png` (~5-10KB)

  **Commit**: NO (groups with Tasks 4, 5, 6)

---

- [ ] 4. Create ProgressBar SVG Silhouette Generator

  **What to do**:
  - In `api/src/ai/pipeline/silhouettes/ui-component-svg.ts`:
  - Implement `createProgressBarSilhouette()`:
    - Canvas: 256x64 pixels (horizontal bar)
    - Track structure:
      - Left cap: Rounded end (8px radius) at x=0
      - Center: Stretchable region (8px margin on each end)
      - Right cap: Rounded end (8px radius) at x=248
    - SVG with rounded rectangle:
      ```svg
      <svg width="256" height="64">
        <rect x="0" y="16" width="256" height="32" rx="8" ry="8" fill="#606060" />
      </svg>
      ```
    - Vertical center with 16px margin top/bottom

  **Must NOT do**:
  - Don't generate the fill bar (just the track background)
  - Don't use complex shapes (simple rounded rectangle)
  - Don't make it vertical (ProgressBar is horizontal only for now)

  **Parallelizable**: YES (with Tasks 3, 5, 6)

  **References**:
  
  **Pattern References**:
  - Task 3 SVG ‚Üí PNG conversion pattern
  - Godot ProgressBar theme properties: `background` StyleBox (what we're generating)

  **WHY Each Reference Matters**:
  - Same SVG ‚Üí PNG conversion as Panel
  - Rounded ends guide AI on end cap styling

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Generate test silhouette:
    ```typescript
    const buffer = await createProgressBarSilhouette({ width: 256, height: 64 });
    fs.writeFileSync('test-progressbar-silhouette.png', buffer);
    ```
  - [ ] Open in viewer
  - [ ] Verify:
    - Rounded left/right ends (8px radius visible)
    - Horizontal bar centered vertically
    - Dimensions 256x64
    - Gray color (#606060)
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0

  **Evidence Required**:
  - [ ] Screenshot of silhouette
  - [ ] Terminal output: tsc success

  **Commit**: NO (groups with Tasks 3, 5, 6)

---

- [ ] 5. Create ScrollBar SVG Silhouette Generator (H + V)

  **What to do**:
  - In `api/src/ai/pipeline/silhouettes/ui-component-svg.ts`:
  - Implement `createScrollBarSilhouette(orientation: 'h' | 'v')`:
    - Horizontal (orientation='h'):
      - Canvas: 256x32 pixels
      - Track: Full width, 24px height, centered vertically
      - Rounded rectangle: `<rect x="0" y="4" width="256" height="24" rx="4" ry="4" />`
    - Vertical (orientation='v'):
      - Canvas: 32x256 pixels
      - Track: Full height, 24px width, centered horizontally
      - Rounded rectangle: `<rect x="4" y="0" width="24" height="256" rx="4" ry="4" />`
    - Use same gray (#606060)

  **Must NOT do**:
  - Don't generate thumb/grabber (separate asset)
  - Don't generate arrow buttons (using post-generation overlay)
  - Don't add grip lines (AI will add if theme requires)

  **Parallelizable**: YES (with Tasks 3, 4, 6)

  **References**:
  
  **Pattern References**:
  - Task 3/4 SVG ‚Üí PNG conversion
  - Godot ScrollBar theme: `scroll` StyleBox (track background)

  **WHY Each Reference Matters**:
  - Orientation parameter creates two variants from one function
  - Slim track shape (24px width/height) for compact UI

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Generate both orientations:
    ```typescript
    const hBuffer = await createScrollBarSilhouette({ orientation: 'h' });
    const vBuffer = await createScrollBarSilhouette({ orientation: 'v' });
    fs.writeFileSync('test-scrollbar-h.png', hBuffer);
    fs.writeFileSync('test-scrollbar-v.png', vBuffer);
    ```
  - [ ] Open in viewer
  - [ ] Verify horizontal:
    - 256x32 dimensions
    - Full-width horizontal bar
    - Rounded ends
  - [ ] Verify vertical:
    - 32x256 dimensions
    - Full-height vertical bar
    - Rounded ends
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0

  **Evidence Required**:
  - [ ] Screenshots of both orientations
  - [ ] Terminal output: tsc success

  **Commit**: NO (groups with Tasks 3, 4, 6)

---

- [ ] 6. Create TabBar SVG Silhouette Generator

  **What to do**:
  - In `api/src/ai/pipeline/silhouettes/ui-component-svg.ts`:
  - Implement `createTabBarSilhouette()`:
    - Canvas: 128x48 pixels (single tab size)
    - Tab shape:
      - Rounded top corners (8px radius)
      - Square bottom (connects to content area)
      - SVG path:
        ```svg
        <svg width="128" height="48">
          <path d="
            M 0 48 L 0 8 Q 0 0 8 0 L 120 0 Q 128 0 128 8 L 128 48 Z
          " fill="#606060" />
        </svg>
        ```
    - Note: This generates ONE tab. Godot tiles it for multiple tabs.

  **Must NOT do**:
  - Don't generate multiple tabs (single tab only)
  - Don't generate close button (post-generation overlay)
  - Don't add text (Godot handles text)

  **Parallelizable**: YES (with Tasks 3, 4, 5)

  **References**:
  
  **Pattern References**:
  - Task 3/4/5 SVG ‚Üí PNG conversion
  - Godot TabBar theme: `tab_selected`, `tab_unselected` StyleBoxes

  **WHY Each Reference Matters**:
  - Single tab with rounded top is classic tab shape
  - Godot TabBar repeats this texture for multiple tabs

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Generate test silhouette:
    ```typescript
    const buffer = await createTabBarSilhouette({ width: 128, height: 48 });
    fs.writeFileSync('test-tab-silhouette.png', buffer);
    ```
  - [ ] Open in viewer
  - [ ] Verify:
    - 128x48 dimensions
    - Rounded top corners
    - Square bottom edge
    - Gray color
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0

  **Evidence Required**:
  - [ ] Screenshot of silhouette
  - [ ] Terminal output: tsc success

  **Commit**: YES (with Tasks 3, 4, 5)
  - Message: `feat(api): add SVG silhouette generators for Panel, ProgressBar, ScrollBar, TabBar`
  - Files: `api/src/ai/pipeline/silhouettes/ui-component-svg.ts`
  - Pre-commit: `cd api && tsc --noEmit`

---


- [ ] 7. Extend Prompt Builder for New Control Types

  **What to do**:
  - Update `api/src/ai/pipeline/prompt-builder.ts`:
  - Extend `buildUIComponentPrompt()` to handle new control types:
    - Add control-specific descriptions:
      ```typescript
      const controlDescriptions: Record<UIComponentType, Record<string, string>> = {
        panel: {
          normal: 'Decorative frame panel. Outer border is ornate, center is hollow/transparent.',
        },
        progress_bar: {
          normal: 'Progress bar track. Horizontal bar with rounded end caps.',
          disabled: 'Inactive progress bar. Grayed out, low contrast.',
        },
        scroll_bar_h: {
          normal: 'Horizontal scrollbar track. Slim horizontal bar, neutral state.',
          hover: 'Scrollbar track on hover. Slightly highlighted.',
          pressed: 'Scrollbar track when grabbing. Active, pressed appearance.',
        },
        scroll_bar_v: {
          normal: 'Vertical scrollbar track. Slim vertical bar, neutral state.',
          hover: 'Scrollbar track on hover. Slightly highlighted.',
          pressed: 'Scrollbar track when grabbing. Active, pressed appearance.',
        },
        tab_bar: {
          selected: 'Active tab. Highlighted, stands out as current selection.',
          unselected: 'Inactive tab. Subtle, recessed appearance.',
          hover: 'Tab on hover. Slightly brighter, inviting click.',
        },
      };
      ```
  - Update prompt template to emphasize control-specific features:
    - Panel: "Decorative frame with HOLLOW CENTER (transparent inside)"
    - ProgressBar: "Rounded end caps, horizontal orientation"
    - ScrollBar: "Slim compact design, {orientation} orientation"
    - TabBar: "Rounded top corners, flat bottom edge"

  **Must NOT do**:
  - Don't add prompts for controls outside the 6
  - Don't specify exact pixel measurements (AI interprets visually)
  - Don't ask for text/icons (post-generation overlay)

  **Parallelizable**: NO (depends on Tasks 1, 3, 4, 5, 6)

  **References**:
  
  **Pattern References**:
  - `api/src/ai/pipeline/prompt-builder.ts:179-197` - Current `buildUIComponentPrompt` function
  - `api/src/ai/pipeline/prompt-builder.ts:164-170` - State description pattern

  **WHY Each Reference Matters**:
  - Existing function shows prompt structure to extend
  - State descriptions show pattern for control-specific variants

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Generate test prompts with Node REPL:
    ```typescript
    import { buildUIComponentPrompt } from './api/src/ai/pipeline/prompt-builder';
    
    const panelPrompt = buildUIComponentPrompt({
      componentType: 'panel',
      state: 'normal',
      theme: 'medieval fantasy with stone textures',
      baseResolution: 256
    });
    console.log(panelPrompt.prompt);
    // Should mention "hollow center" and "decorative frame"
    
    const tabPrompt = buildUIComponentPrompt({
      componentType: 'tab_bar',
      state: 'selected',
      theme: 'futuristic neon',
      baseResolution: 128
    });
    console.log(tabPrompt.prompt);
    // Should mention "active tab" and "rounded top corners"
    ```
  - [ ] Verify prompts contain control-specific keywords
  - [ ] TypeScript compiles: `cd api && tsc --noEmit` ‚Üí Exit code 0

  **Evidence Required**:
  - [ ] Terminal output showing generated prompts
  - [ ] Confirmation control-specific descriptions appear
  - [ ] tsc success

  **Commit**: YES
  - Message: `feat(api): extend prompt builder for new UI control types`
  - Files: `api/src/ai/pipeline/prompt-builder.ts`
  - Pre-commit: `cd api && tsc --noEmit`

---

- [ ] 8. Update Pipeline Stages for New Control Types

  **What to do**:
  - Update `api/src/ai/pipeline/stages/ui-component.ts`:
  - Extend `baseStateGenerationStage` to handle new control types:
    - Route silhouette generation based on control type:
      ```typescript
      let silhouettePng: Uint8Array;
      switch (spec.componentType) {
        case 'button':
        case 'checkbox':
          silhouettePng = await createNinePatchSilhouette({ ... }); // Existing POC
          break;
        case 'panel':
          silhouettePng = await createPanelSilhouette({ ... });
          break;
        case 'progress_bar':
          silhouettePng = await createProgressBarSilhouette({ ... });
          break;
        case 'scroll_bar_h':
          silhouettePng = await createScrollBarSilhouette({ orientation: 'h' });
          break;
        case 'scroll_bar_v':
          silhouettePng = await createScrollBarSilhouette({ orientation: 'v' });
          break;
        case 'tab_bar':
          silhouettePng = await createTabBarSilhouette({ ... });
          break;
      }
      ```
  - Use control-specific state arrays from Task 1:
    ```typescript
    const states = UI_CONTROL_CONFIG[spec.componentType].states;
    ```
  - No changes to variation stage (already generic)

  **Must NOT do**:
  - Don't modify POC logic for Button/CheckBox (proven to work)
  - Don't add parallel generation (keep sequential for consistency)
  - Don't skip background removal (consistent with POC)

  **Parallelizable**: NO (depends on Task 7)

  **References**:
  
  **Pattern References**:
  - `api/src/ai/pipeline/stages/ui-component.ts:baseStateGenerationStage` - Current implementation
  - `api/src/ai/pipeline/stages/ui-component.ts:variationStateGenerationStage` - Already generic

  **WHY Each Reference Matters**:
  - Base stage shows where to add silhouette routing
  - Variation stage is already control-agnostic (no changes needed)

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Create test script:
    ```typescript
    import { executeGameAssets } from './api/src/ai/pipeline';
    const config: GameAssetConfig = {
      gameId: 'test-ui-controls',
      assets: [
        { type: 'sheet', kind: 'ui_component', componentType: 'panel', states: ['normal'], ninePatchMargins: { ... } },
        { type: 'sheet', kind: 'ui_component', componentType: 'progress_bar', states: ['normal', 'disabled'], ninePatchMargins: { ... } },
      ]
    };
    const result = await executeGameAssets(config, adapters);
    console.log(result);
    ```
  - [ ] Run: `npx tsx api/scripts/test-new-controls.ts`
  - [ ] Verify:
    - Panel silhouette generated (hollow frame)
    - ProgressBar silhouette generated (rounded ends)
    - Scenario.com API calls succeed
    - Images downloaded and bg-removed
    - R2 upload successful
  - [ ] Check debug output: `api/debug-output/test-ui-controls/` contains all stages

  **Evidence Required**:
  - [ ] Terminal output: successful generation
  - [ ] Screenshots of generated Panel and ProgressBar
  - [ ] File structure showing R2 uploads

  **Commit**: YES
  - Message: `feat(api): extend UI pipeline stages for new control types`
  - Files: `api/src/ai/pipeline/stages/ui-component.ts`
  - Pre-commit: `cd api && tsc --noEmit`

---


- [ ] 9. Extend ThemedUIComponent for New Control Types

  **What to do**:
  - Update `godot_project/scripts/ui/ThemedUIComponent.gd`:
  - Extend `ComponentType` enum:
    ```gdscript
    enum ComponentType { 
      BUTTON, 
      CHECKBOX,
      PANEL,
      PROGRESS_BAR,
      SCROLL_BAR_H,
      SCROLL_BAR_V,
      TAB_BAR
    }
    ```
  - Update `_create_control_node()` to instantiate correct Godot node:
    ```gdscript
    func _create_control_node() -> void:
      if _control_node:
        _control_node.queue_free()
      
      match _component_type:
        ComponentType.BUTTON:
          var btn = Button.new()
          # ... existing Button logic
          _control_node = btn
        ComponentType.CHECKBOX:
          var chk = CheckBox.new()
          # ... existing CheckBox logic
          _control_node = chk
        ComponentType.PANEL:
          var panel = Panel.new()
          panel.name = "Panel"
          _control_node = panel
        ComponentType.PROGRESS_BAR:
          var pb = ProgressBar.new()
          pb.name = "ProgressBar"
          pb.show_percentage = false
          _control_node = pb
        ComponentType.SCROLL_BAR_H:
          var sb = HScrollBar.new()
          sb.name = "HScrollBar"
          _control_node = sb
        ComponentType.SCROLL_BAR_V:
          var sb = VScrollBar.new()
          sb.name = "VScrollBar"
          _control_node = sb
        ComponentType.TAB_BAR:
          var tb = TabBar.new()
          tb.name = "TabBar"
          _control_node = tb
      
      add_child(_control_node)
    ```
  - Update `_apply_styles()` to handle different node types:
    - Panel: Only `panel` StyleBox
    - ProgressBar: `background` StyleBox (fill is runtime)
    - ScrollBar: `scroll`, `scroll_focus`, `grabber`, `grabber_highlight`, `grabber_pressed` StyleBoxes
    - TabBar: `tab_selected`, `tab_unselected`, `tab_hover` StyleBoxes

  **Must NOT do**:
  - Don't modify existing Button/CheckBox logic (proven to work)
  - Don't add animation code (static textures only)
  - Don't generate icons (post-generation overlay)

  **Parallelizable**: NO (depends on Tasks 1, 2)

  **References**:
  
  **Pattern References**:
  - `godot_project/scripts/ui/ThemedUIComponent.gd:48-74` - Current `_create_control_node` logic
  - `godot_project/scripts/ui/ThemedUIComponent.gd:169-195` - Current `_apply_styles` logic
  - Godot docs: Node types (Panel, ProgressBar, HScrollBar, VScrollBar, TabBar)

  **WHY Each Reference Matters**:
  - Existing node creation shows pattern to extend
  - Existing style application shows where to add control-specific logic
  - Godot node docs show which theme properties each control supports

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Open Godot project: `godot godot_project/project.godot`
  - [ ] Create test scene: `test_new_controls.tscn`
  - [ ] Add script:
    ```gdscript
    extends Node2D
    
    func _ready():
      # Test Panel
      var panel = ThemedUIComponent.new()
      panel.setup(
        ThemedUIComponent.ComponentType.PANEL,
        "http://localhost:8787/assets/generated/test-ui/panel/metadata.json",
        ""
      )
      add_child(panel)
      
      # Test ProgressBar
      var pb = ThemedUIComponent.new()
      pb.setup(
        ThemedUIComponent.ComponentType.PROGRESS_BAR,
        "http://localhost:8787/assets/generated/test-ui/progress_bar/metadata.json",
        ""
      )
      pb.position = Vector2(0, 100)
      add_child(pb)
    ```
  - [ ] Run scene (F6)
  - [ ] Verify:
    - Panel node created successfully
    - ProgressBar node created successfully
    - No Godot errors in console
  - [ ] Verify (after assets generated in Task 8):
    - Panel displays themed frame
    - ProgressBar displays themed track

  **Evidence Required**:
  - [ ] Screenshot: test scene with Panel and ProgressBar placeholders
  - [ ] Godot console output: no errors
  - [ ] (After Task 8) Screenshot: themed Panel and ProgressBar

  **Commit**: NO (groups with Task 10)

---

- [ ] 10. Add GameBridge Methods for New Controls

  **What to do**:
  - Update `godot_project/scripts/GameBridge.gd`:
  - Add bridge methods for new controls:
    ```gdscript
    func createUIPanel(id: String, x: float, y: float, w: float, h: float, metadata_url: String) -> void:
      var component = ThemedUIComponent.new()
      component.setup(ThemedUIComponent.ComponentType.PANEL, metadata_url, "")
      component.position = Vector2(x, y)
      component.custom_minimum_size = Vector2(w, h)
      _ui_controls[id] = component
      _game_root.add_child(component)
    
    func createUIProgressBar(id: String, x: float, y: float, w: float, h: float, metadata_url: String) -> void:
      var component = ThemedUIComponent.new()
      component.setup(ThemedUIComponent.ComponentType.PROGRESS_BAR, metadata_url, "")
      component.position = Vector2(x, y)
      component.custom_minimum_size = Vector2(w, h)
      _ui_controls[id] = component
      _game_root.add_child(component)
    
    func createUIScrollBar(id: String, orientation: String, x: float, y: float, w: float, h: float, metadata_url: String) -> void:
      var type = ThemedUIComponent.ComponentType.SCROLL_BAR_H if orientation == "h" else ThemedUIComponent.ComponentType.SCROLL_BAR_V
      var component = ThemedUIComponent.new()
      component.setup(type, metadata_url, "")
      component.position = Vector2(x, y)
      component.custom_minimum_size = Vector2(w, h)
      _ui_controls[id] = component
      _game_root.add_child(component)
    
    func createUITabBar(id: String, x: float, y: float, w: float, h: float, tab_count: int, metadata_url: String) -> void:
      var component = ThemedUIComponent.new()
      component.setup(ThemedUIComponent.ComponentType.TAB_BAR, metadata_url, "")
      component.position = Vector2(x, y)
      component.custom_minimum_size = Vector2(w, h)
      # Add tabs
      var tab_bar = component._control_node as TabBar
      for i in tab_count:
        tab_bar.add_tab("Tab " + str(i + 1))
      _ui_controls[id] = component
      _game_root.add_child(component)
    ```
  - Add generic destroy method (if not exists):
    ```gdscript
    func destroyUIControl(id: String) -> void:
      if _ui_controls.has(id):
        var control = _ui_controls[id]
        control.queue_free()
        _ui_controls.erase(id)
    ```

  **Must NOT do**:
  - Don't modify existing `createUIButton` (proven to work)
  - Don't add event handling yet (focus on rendering first)
  - Don't add complex TabBar logic (simple tab addition only)

  **Parallelizable**: NO (depends on Task 9)

  **References**:
  
  **Pattern References**:
  - `godot_project/scripts/GameBridge.gd` - Look for existing `createUIButton` method
  - Task 9 - ThemedUIComponent enum values

  **WHY Each Reference Matters**:
  - Existing createUIButton shows pattern to follow
  - ThemedUIComponent enum provides type values

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Open Godot project
  - [ ] Open `godot_project/scripts/GameBridge.gd`
  - [ ] Verify new methods exist
  - [ ] Test via GDScript console (or test scene):
    ```gdscript
    GameBridge.createUIPanel("test-panel", 100, 100, 200, 200, "http://...")
    GameBridge.createUIProgressBar("test-pb", 100, 350, 300, 40, "http://...")
    ```
  - [ ] Verify:
    - Controls created without errors
    - Controls positioned correctly
    - Controls sized correctly
  - [ ] No Godot errors in console

  **Evidence Required**:
  - [ ] Code snippet showing new methods
  - [ ] Screenshot: controls created via bridge
  - [ ] Godot console: no errors

  **Commit**: YES (with Task 9)
  - Message: `feat(godot): extend ThemedUIComponent and GameBridge for new control types`
  - Files: `godot_project/scripts/ui/ThemedUIComponent.gd`, `godot_project/scripts/GameBridge.gd`
  - Pre-commit: Open Godot, verify no errors

---


- [ ] 11. Create Godot Test Scene for All Controls

  **What to do**:
  - Create `godot_project/scenes/test_ui_theme.tscn`:
  - Scene contents:
    - Node2D root
    - Background ColorRect (for contrast)
    - 6 ThemedUIComponent instances with labels:
      1. Button (from POC, verify still works)
      2. CheckBox (from POC, verify still works)
      3. Panel (new)
      4. ProgressBar (new)
      5. ScrollBar H (new)
      6. ScrollBar V (new)
      7. TabBar with 3 tabs (new)
    - Each control at different sizes to test nine-patch stretch:
      - Normal size
      - 2x size
      - 3x size
    - Label nodes showing control names and sizes
  - Add instructions label: "All controls use same theme. Verify visual consistency."

  **Must NOT do**:
  - Don't add complex interactions (focus on visual rendering)
  - Don't add other control types
  - Don't add multiple themes (single theme test only)

  **Parallelizable**: NO (depends on Task 10)

  **References**:
  
  **Pattern References**:
  - `godot_project/scenes/test_ui_components.tscn` - Existing test scene from POC (if exists)
  - Task 10 - GameBridge methods for control creation

  **WHY Each Reference Matters**:
  - Existing test scene shows scene structure pattern
  - GameBridge methods show how to create controls

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Open scene in Godot editor: `godot_project/scenes/test_ui_theme.tscn`
  - [ ] Run scene (F6)
  - [ ] Verify visual layout:
    - All 7 controls visible
    - Controls arranged clearly (grid or vertical list)
    - Labels identify each control
    - Multiple sizes show nine-patch stretch
  - [ ] Verify (after assets generated):
    - All controls display themed backgrounds
    - Theme looks consistent across controls
    - Nine-patch stretching works correctly (borders don't distort)
  - [ ] No Godot errors in console

  **Evidence Required**:
  - [ ] Screenshot: test scene layout (placeholders)
  - [ ] (After Task 12) Screenshot: fully themed scene
  - [ ] Screenshot: 2x and 3x sizes showing stretch
  - [ ] Godot console: no errors

  **Commit**: YES
  - Message: `feat(godot): add comprehensive test scene for UI theme system`
  - Files: `godot_project/scenes/test_ui_theme.tscn`
  - Pre-commit: Open Godot, verify no errors

---

- [ ] 12. Implement Batch API for Theme Generation

  **What to do**:
  - Update `api/src/trpc/routes/ui-components.ts`:
  - Extend `generateUIComponent` mutation to accept array:
    ```typescript
    .input(z.object({
      gameId: z.string(),
      theme: z.union([
        z.string(),
        z.object({ palette: z.array(z.string()), texture: z.string(), era: z.string() })
      ]),
      controls: z.array(z.enum([
        'button', 'checkbox', 'panel', 'progress_bar', 'scroll_bar_h', 'scroll_bar_v', 'tab_bar'
      ])),
      baseResolution: z.number().default(256),
    }))
    .mutation(async ({ input, ctx }) => {
      const results: Array<{ control: string; success: boolean; publicUrls?: string[]; error?: string }> = [];
      
      // Sequential generation for consistency
      for (const controlType of input.controls) {
        try {
          const config = UI_CONTROL_CONFIG[controlType];
          const spec: UIComponentSheetSpec = {
            type: 'sheet',
            kind: 'ui_component',
            id: `${input.gameId}-${controlType}`,
            componentType: controlType,
            states: config.states,
            ninePatchMargins: config.margins,
            baseResolution: input.baseResolution,
            // ... other fields
          };
          
          // Execute pipeline
          const result = await executeGameAssets(/*...*/);
          
          results.push({
            control: controlType,
            success: true,
            publicUrls: result.publicUrls,
          });
        } catch (error) {
          results.push({
            control: controlType,
            success: false,
            error: error.message,
          });
        }
      }
      
      return {
        totalRequested: input.controls.length,
        successful: results.filter(r => r.success).length,
        failed: results.filter(r => !r.success).length,
        results,
      };
    })
    ```

  **Must NOT do**:
  - Don't add parallel generation (sequential for consistency)
  - Don't add regeneration logic (one-shot generation)
  - Don't add theme persistence (theme is input parameter)

  **Parallelizable**: NO (depends on Tasks 1, 8)

  **References**:
  
  **Pattern References**:
  - `api/src/trpc/routes/ui-components.ts` - Existing single-control generation
  - `api/src/trpc/routes/asset-system.ts` - Batch generation pattern from asset system
  - Task 1 - UI_CONTROL_CONFIG

  **WHY Each Reference Matters**:
  - Existing route shows structure to extend
  - Asset system shows batch generation pattern
  - UI_CONTROL_CONFIG provides states/margins per control

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Start API server: `pnpm dev`
  - [ ] Test batch generation with curl:
    ```bash
    curl -X POST http://localhost:8787/trpc/uiComponents.generateUIComponent \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer YOUR_TOKEN" \
      -d '{
        "gameId": "test-theme",
        "theme": "medieval fantasy with stone textures",
        "controls": ["button", "panel", "progress_bar", "tab_bar"]
      }'
    ```
  - [ ] Verify response:
    - Status 200
    - Response body contains:
      ```json
      {
        "totalRequested": 4,
        "successful": 4,
        "failed": 0,
        "results": [
          { "control": "button", "success": true, "publicUrls": [...] },
          { "control": "panel", "success": true, "publicUrls": [...] },
          { "control": "progress_bar", "success": true, "publicUrls": [...] },
          { "control": "tab_bar", "success": true, "publicUrls": [...] }
        ]
      }
      ```
  - [ ] Verify database:
    ```sql
    SELECT * FROM asset_packs WHERE game_id='test-theme';
    ```
  - [ ] Verify R2 storage:
    - Check `.wrangler/state/v3/r2/slopcade-assets-dev/generated/test-theme/`
    - Each control has: normal.png, metadata.json, etc.
  - [ ] Verify all public URLs accessible

  **Evidence Required**:
  - [ ] curl command output showing success
  - [ ] Database query showing stored packs
  - [ ] R2 file listing
  - [ ] Public URLs accessible via browser
  - [ ] TypeScript compiles: `cd api && tsc --noEmit`

  **Commit**: YES
  - Message: `feat(api): implement batch UI theme generation API`
  - Files: `api/src/trpc/routes/ui-components.ts`
  - Pre-commit: `cd api && tsc --noEmit`

---

- [ ] 13. End-to-End Manual QA

  **What to do**:
  - Full workflow test (API ‚Üí Godot ‚Üí Visual Verification):
    1. Generate 3 complete themes with all 6 controls:
       - Theme 1: "medieval fantasy with stone textures"
       - Theme 2: "futuristic sci-fi with neon glows"
       - Theme 3: "cartoon style with bright colors"
    2. For each theme:
       - Call batch API
       - Verify all 6 controls generated
       - Update Godot test scene metadata URLs
       - Load in Godot and screenshot
    3. Visual quality assessment:
       - Theme consistency across controls
       - Nine-patch quality at multiple sizes
       - Panel transparency (hollow center)
       - ProgressBar end caps
       - ScrollBar H/V consistency
       - TabBar tab appearance
    4. Performance metrics:
       - Total generation time per theme
       - Individual control generation times
       - File sizes
       - Load times in Godot
  - Document findings in `.sisyphus/notepads/ui-theme-qa/qa-results.md`:
    - Screenshots (3 themes √ó 7 controls = 21 images minimum)
    - Generation time measurements
    - Issues found (if any)
    - Visual quality ratings per control/theme
    - Recommendations for prompt tuning

  **Must NOT do**:
  - Don't fix issues yet (document for iteration)
  - Don't test other control types
  - Don't test animations or interactions

  **Parallelizable**: NO (depends on ALL previous tasks)

  **References**:
  
  **Pattern References**:
  - `debug-output/ui-button-test/REPORT.md` - Issue documentation format
  - `debug-output/ui-button-test/REPORT.md` - POC test report format

  **WHY Each Reference Matters**:
  - Previous issue docs show what problems to look for
  - Test report format shows structure for results

  **Acceptance Criteria**:

  **Manual Execution Verification**:
  - [ ] Generate 3 themes:
    ```bash
    # Medieval
    curl -X POST ... -d '{"theme": "medieval fantasy", "controls": ["button","checkbox","panel","progress_bar","scroll_bar_h","scroll_bar_v","tab_bar"]}'
    
    # Sci-fi
    curl -X POST ... -d '{"theme": "futuristic sci-fi", "controls": [...]}'
    
    # Cartoon
    curl -X POST ... -d '{"theme": "cartoon style", "controls": [...]}'
    ```
  - [ ] For each theme:
    - [ ] Verify all 7 controls generated successfully
    - [ ] Load in Godot test scene (update metadata URLs)
    - [ ] Screenshot normal size
    - [ ] Screenshot 2x size (verify nine-patch stretch)
    - [ ] Screenshot 3x size (verify stretch quality)
    - [ ] Measure generation time
  - [ ] Visual assessments:
    - [ ] Theme consistency: Do all controls look like they belong together?
    - [ ] Panel hollow center: Is center transparent?
    - [ ] ProgressBar caps: Are end caps rounded and clean?
    - [ ] ScrollBar: Do H and V look consistent?
    - [ ] TabBar: Are selected/unselected visually distinct?
    - [ ] Nine-patch: Do borders stay crisp at 2x/3x sizes?
  - [ ] Create QA report: `.sisyphus/notepads/ui-theme-qa/qa-results.md`
  - [ ] Include:
    - Screenshots (organized by theme and control)
    - Generation time table
    - Issues/observations
    - Quality ratings (1-5 stars) per control/theme
    - Recommendations for iteration

  **Evidence Required**:
  - [ ] Screenshots: 3 themes √ó 7 controls √ó 3 sizes = 63 images minimum
  - [ ] QA report with findings
  - [ ] Generation time logs
  - [ ] Summary: "System complete and functional" or "Needs iteration on X"

  **Commit**: YES
  - Message: `docs: add UI theme system QA results`
  - Files: `.sisyphus/notepads/ui-theme-qa/qa-results.md`, screenshots
  - Pre-commit: None (documentation only)

---

## Commit Strategy

| After Task | Message | Files | Verification |
|------------|---------|-------|--------------|
| 2 | `feat(api): add type system for 6 UI control types` | types.ts, ui-control-config.ts | tsc --noEmit |
| 6 | `feat(api): add SVG silhouette generators for Panel, ProgressBar, ScrollBar, TabBar` | ui-component-svg.ts | tsc --noEmit |
| 7 | `feat(api): extend prompt builder for new UI control types` | prompt-builder.ts | tsc --noEmit |
| 8 | `feat(api): extend UI pipeline stages for new control types` | stages/ui-component.ts | tsc --noEmit |
| 10 | `feat(godot): extend ThemedUIComponent and GameBridge for new control types` | ThemedUIComponent.gd, GameBridge.gd | Godot error check |
| 11 | `feat(godot): add comprehensive test scene for UI theme system` | test_ui_theme.tscn | Godot error check |
| 12 | `feat(api): implement batch UI theme generation API` | routes/ui-components.ts | tsc --noEmit |
| 13 | `docs: add UI theme system QA results` | QA report, screenshots | N/A |

---

## Success Criteria

### Verification Commands
```bash
# TypeScript compilation
cd api && tsc --noEmit

# Test batch generation
curl -X POST http://localhost:8787/trpc/uiComponents.generateUIComponent \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"gameId": "test", "theme": "medieval", "controls": ["button","panel"]}'

# R2 verification
ls -la .wrangler/state/v3/r2/slopcade-assets-dev/generated/test/

# Godot test
# Open godot_project/scenes/test_ui_theme.tscn and run (F6)
```

### Final Checklist
- [ ] All "Must Have" features implemented
- [ ] All "Must NOT Have" guardrails respected
- [ ] All 6 control types generate successfully
- [ ] Panel has transparent center (hollow frame)
- [ ] ProgressBar track tiles horizontally
- [ ] ScrollBar H and V both work
- [ ] TabBar selected/unselected states are distinct
- [ ] Batch API generates all controls from single call
- [ ] Nine-patch rendering works at multiple sizes
- [ ] Generation completes in <5 minutes per full theme
- [ ] No TypeScript compilation errors
- [ ] Manual QA documented with screenshots
- [ ] Godot test scene runs without errors
- [ ] All controls look themed and visually coherent

---

## Notes

### Experimentation Areas

As user noted, "it's all possible, just grunt work" with some experimentation needed:

1. **SVG Silhouette Validation**: The hollow Panel frame and symbol embedding approaches need visual validation
2. **Prompt Tuning**: Control-specific prompts may need iteration to achieve desired aesthetic
3. **Symbol Overlay vs Embedded**: System designed to switch between post-generation overlay and embedded generation

### Known Limitations (Accepted)

- **No cross-control consistency enforcement**: Each control generated independently. Visual coherence relies on using the same theme prompt.
- **No automatic margin detection**: Margins are hardcoded per control type.
- **No animated states**: Static textures only (matches POC design).

### Future Considerations (Out of Scope)

- Additional control types (LineEdit, Tree, PopupMenu, etc.)
- Theme persistence and management UI
- Regeneration workflows
- Embedded symbol generation (vs overlay)
- User-configurable margins
- Theme marketplace/gallery

